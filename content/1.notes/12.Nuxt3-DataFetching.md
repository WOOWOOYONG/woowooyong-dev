---
title: 'Nuxt3 - å¯ä»¥å…ˆçµ¦æˆ‘é€™äº›è³‡æ–™å—ï¼Ÿ'
description: 'å¦‚ä½•åœ¨Nuxt3ä¸­ç™¼é€APIè«‹æ±‚'
date: '2023-10-24'
category: 'Nuxt'
tags:
  - Nuxt3
---

# Nuxt3 - Data Fetching

## ç°¡ä»‹
- Nuxt3 æä¾›äº†åŸºæ–¼ofetchå°è£çš„composablesæ–¹æ³•ä¾†åšdata fetching
- æ ¹æ“šéœ€æ±‚ï¼Œå¯ä»¥åœ¨serverç«¯æˆ–clientç«¯ä½¿ç”¨

## èˆ‡Server Side Renderingçš„é—œä¿‚
Nuxtçš„SSRç°¡å–®æ­¥é©Ÿå¦‚ä¸‹
1. é¦–æ¬¡è¼‰å…¥é é¢ï¼Œå¾serverç«¯ç™¼å‡ºAPIè«‹æ±‚ (Data Fetching)
2. æŠŠå›å‚³çš„è³‡æ–™åµŒå…¥HTML ï¼ˆåŸå§‹ç¢¼æœ‰åˆ©æ–¼çˆ¬èŸ²ï¼ŒåŠ å¼·SEOï¼‰
3. å›å‚³å®Œæ•´çš„HTMLåˆ°å®¢æˆ¶ç«¯
4. ä½¿ç”¨è€…çœ‹åˆ°ç•«é¢

## useAsyncData

- åœ¨ä¼ºæœå™¨ç«¯ç™¼APIè«‹æ±‚ä½¿ç”¨
- å»ºè­°ç›´æ¥åœ¨`<script setup> </script>` å…§ç•¶æˆä¸€å€‹ç”Ÿå‘½é€±æœŸä½¿ç”¨
- åœ¨ä¼ºæœå™¨ç«¯ï¼Œå®ƒå°‡åœ¨æ¸²æŸ“ä¹‹å‰è¢«èª¿ç”¨
- åœ¨å®¢æˆ¶ç«¯ï¼Œå®ƒå°‡åœ¨çµ„ä»¶é¦–æ¬¡æ¸²æŸ“ä¹‹å‰è¢«èª¿ç”¨
- éœ€è¦æœ‰ä¸€å€‹å”¯ä¸€çš„keyï¼Œé¿å…åœ¨clientç«¯é‡è¦†å‚³é€è«‹æ±‚
- æ²’æœ‰è¨­å®škeyçš„è©±æœƒè‡ªå‹•ç”Ÿæˆä¸€å€‹å°æ‡‰æª”æ¡ˆåå’Œç·¨è™Ÿçš„å”¯ä¸€key
- ä½¿ç”¨å ´æ™¯ï¼šç•¶é é¢ä¸€è¼‰å…¥å°±éœ€è¦è«‹æ±‚APIè³‡æ–™

```vue
<script setup>
const { data, pending, error, refresh } = await useAsyncData(
  'count',
  () => $fetch('/api/count')
)
</script>
<template>
{{ data }}
</template>
```


> ğŸ” The first argument ofÂ `useAsyncData`Â is the unique key used to cache the response of the second argument, the querying function. This argument can be ignored by directly passing the querying function. In that case, it will be auto-generated.

### å¯ä»¥å‚³å…¥çš„åƒæ•¸
- **key**
  - å”¯ä¸€éµï¼Œå¯ä»¥ç¢ºä¿è³‡æ–™ä¸æœƒé‡è¤‡çš„ç²å–ï¼Œä¹Ÿå°±æ˜¯å¦‚æœ Key ç›¸åŒä¾¿ä¸æœƒå†ç™¼é€ç›¸åŒçš„è«‹æ±‚ï¼Œé™¤éé‡æ–°æ•´ç†é é¢ç”±å¾Œç«¯å†æ¬¡æ¸²æŸ“ç²å–ï¼Œæˆ–å‘¼å«Â `useAsyncData`Â å›å‚³çš„Â `refresh()`Â å‡½æ•¸é‡æ–°å–å¾—è³‡æ–™
- **handler**
  - å›å‚³ç•°æ­¥è«‹æ±‚è³‡æ–™çš„è™•ç†å‡½æ•¸ï¼Œæ‰“ API æˆ–åŠ å·¥çš„ç•°æ­¥é‚è¼¯éƒ½å¯ä»¥åœ¨é€™è£¡è™•ç†
- **options**:
     - **server**: æ˜¯å¦åœ¨ä¼ºæœå™¨ç«¯ç²å–è³‡æ–™ï¼Œé è¨­ç‚ºÂ `true`
    - **lazy**: æ˜¯å¦æ–¼è¼‰å…¥è·¯ç”±å¾Œæ‰é–‹å§‹åŸ·è¡Œç•°æ­¥è«‹æ±‚å‡½æ•¸ï¼Œé è¨­ç‚ºÂ `false`ï¼Œæ‰€ä»¥æœƒé˜»æ­¢è·¯ç”±è¼‰å…¥ç›´åˆ°è«‹æ±‚å®Œæˆå¾Œæ‰é–‹å§‹æ¸²æŸ“é é¢å…ƒä»¶
    - **default**: ç•¶å‚³å…¥é€™å€‹ factory functionï¼Œå¯ä»¥å°‡ç•°æ­¥è«‹æ±‚ç™¼é€èˆ‡å›å‚³è§£æå‰ï¼Œè¨­å®šè³‡æ–™çš„é è¨­å€¼ï¼Œå°æ–¼è¨­å®šÂ `lazy: true`Â é¸é …ç‰¹åˆ¥æœ‰ç”¨è™•ï¼Œè‡³å°‘æœ‰å€‹é è¨­å€¼å¯ä»¥ä½¿ç”¨åŠæ¸²æŸ“é¡¯ç¤º
    - **transform**: ä¿®æ”¹åŠ å·¥Â `handler`Â å›å‚³çµæœçš„å‡½æ•¸
    - **pick**:Â `handler`Â è‹¥å›å‚³ä¸€å€‹ç‰©ä»¶ï¼Œåªå¾ä¸­ä¾ç…§éœ€è¦çš„ key å–å‡ºè³‡æ–™ï¼Œä¾‹å¦‚åªå¾ JSON ç‰©ä»¶ä¸­å–çš„æŸå¹¾å€‹ key çµ„æˆæ–°çš„ç‰©ä»¶
    - **watch**: ç›£è½Â `ref`Â æˆ–Â `reactive`Â éŸ¿æ‡‰å¼è³‡æ–™ç™¼ç”Ÿè®ŠåŒ–æ™‚ï¼Œè§¸ç™¼é‡æ–°è«‹æ±‚è³‡æ–™ï¼Œé©ç”¨æ–¼è³‡æ–™åˆ†é ã€éæ¿¾çµæœæˆ–æœå°‹ç­‰æƒ…å¢ƒ
    - **initialCache**: é è¨­ç‚ºÂ `true`ï¼Œç•¶ç¬¬ä¸€æ¬¡è«‹æ±‚è³‡æ–™æ™‚ï¼Œå°‡æœƒæŠŠæœ‰æ•ˆçš„ payload å¿«å–ï¼Œä¹‹å¾Œçš„è«‹æ±‚åªè¦æ˜¯ç›¸åŒçš„ keyï¼Œéƒ½æœƒç›´æ¥å›å‚³å¿«å–çš„çµæœ
    - **immediate**: é è¨­ç‚ºÂ `true`ï¼Œè«‹æ±‚å°‡æœƒç«‹å³è§¸ç™¼
  
**æ”¶åˆ°çš„å›å‚³å€¼**
  - **`data`**: the result of the asynchronous function that is passed in
  - **`pending`**: a boolean indicating whether the data is still being fetched
  - **`refresh/execute`**: a function that can be used to refresh the data returned by theÂ **`handler`**Â function
  - **`error`**: an error object if the data fetching failed

## $fetch
- å¦‚æœè¦å°è£å»ºè­°ä½¿ç”¨$fetch
- å¦‚æœç›´æ¥åœ¨`<script setup></script>`ä¸­ä½¿ç”¨ï¼Œæœƒå…ˆåœ¨serverç«¯è«‹æ±‚è³‡æ–™ï¼Œåˆåœ¨clientç«¯é‡è¦†è«‹æ±‚
- ä½¿ç”¨å ´æ™¯ï¼š
  - åœ¨å®¢æˆ¶ç«¯ä½¿ç”¨è€…ç™¼é€è«‹æ±‚ (ex: é€å‡ºè¡¨å–®)
  - åœ¨ä¼ºæœå™¨ç«¯ç™¼é€APIè«‹æ±‚æ™‚ä½¿ç”¨ 

```js
const users = await $fetch('/api/users').catch((error) => error.data)
```

### åœ¨Server Sideç™¼é€APIè«‹æ±‚
- `server/api/pokemon.js`
```js
// Server Side
export default defineEventHandler(async event => {
  const data  = await $fetch(`https://pokeapi.co/api/v2/pokemon/charizard`)

  return data
})

```
- å¾clientç«¯å‚³å…¥å‹•æ…‹è·¯å¾‘
- `server/api/[pokemon].js`
```js
export default defineEventHandler(async event => {
  const { pokemon } = event.context.params
  const data  = await $fetch(`https://pokeapi.co/api/v2/pokemon/${pokemon}`)

  return data
})

```


**å°è£ç¯„ä¾‹**
```js
const apiFetch = $fetch.create({
  baseURL: 'https://some-domain.com/api',
  timeout: 1000,
  headers: { 'Content-Type': 'application/json' }
})
```


## useFetch

- useAsyncDataå’Œ$fetchçš„çµ„åˆæ–¹æ³•
- å»ºè­°ä¸è¦ç•¶æˆaxiosä¾†å°è£ä½¿ç”¨
- å»ºè­°ä¸è¦åŒ…è£åœ¨å‡½å¼ã€ç”Ÿå‘½é€±æœŸ(onMountedâ€¦.)ã€watchâ€¦.ç­‰

```tsx
// ç›¸ç•¶æ–¼
useAsyncData(url, () => $fetch(url))

//ä¾‹å¦‚
const { data } = await useFetch(url)

//ç­‰åŒæ–¼
const { data } = await useAsyncData('nuxt3Test', () => {
	return $fetch(url)
}) 
```

```vue
<script setup>
const { data: count } = await useFetch('/api/count')
</script>

<template>
  Page visits: {{ count }}
</template>
```

- Getè«‹æ±‚ï¼šå¸¶å…¥queryåƒæ•¸å¯«æ³•

```js
const { data } = await useFetch(url, {
	query: { page: 1, list: 20 }
})
```

- **Options (extendsÂ [unjs/ofetch](https://github.com/unjs/ofetch)Â options &Â [AsyncDataOptions](https://nuxt.com/docs/api/composables/use-async-data#params))**:
    - `method`: HTTPè«‹æ±‚æ–¹æ³•
    - `query`:  å°‡åƒæ•¸é€é`?`çš„æ–¹å¼å¸¶åˆ°URLä¸Š
    - `params`: å°‡åƒæ•¸å¸¶åˆ°URLä¸Š
    - `body`: Request body - automatically stringified (if an object is passed).
    - `headers`: Request headers.
    - `baseURL`: åŸºæœ¬çš„API URLè·¯å¾‘


    

## åŠ ä¸ŠLazy 
- `useLazyFetch`, `useLazyAsyncData`
- æœƒå…ˆè¼‰å…¥é é¢ï¼Œé¡¯ç¤ºéœæ…‹å…§å®¹ï¼Œç­‰å–å¾—è³‡æ–™å¾Œå†æ¸²æŸ“ç•«é¢
- å’Œç›´æ¥åŠ å…¥åƒæ•¸`lazy: true`çš„æ•ˆæœç›¸åŒ
- éœ€è¦è™•ç†ä¸€é–‹å§‹dataç‚º`null`çš„ç‹€æ…‹ï¼ˆex: åŠ ä¸ŠLoadingæç¤ºï¼‰

```tsx
const { pending, data: posts } = useLazyFetch('/api/posts')

// ç­‰åŒæ–¼
const { pending, data: posts } = useLazyFetch('/api/posts', {
  lazy: true
})
```



## é‡æ–°è«‹æ±‚è³‡æ–™

### æ‰‹å‹•æ›´æ–°
1. é€é`refresh`æ–¹æ³•é€²è¡Œåˆ·æ–°
```vue
<script setup lang="ts">
const { data, error, refresh } = await useFetch('/api/users')
</script>

<template>
  <div>
    <p>{{ data }}</p>
    <button @click="refresh">Refresh data</button>
  </div>
</template>

```

2. é€éå”¯ä¸€çš„keyä½¿ç”¨`refreshNuxtData`é‡æ–°è§¸ç™¼æŠ“å–è³‡æ–™

```jsx
const { data } = await useAsyncData("userInfo", () => {
	return $fetch("/api/auth/userInfo")
})

const refreshGetData = () => {
	refreshNuxtData("userInfo")
}
```
### è‡ªå‹•æ›´æ–°
- å¯«æ³•1ï¼šç•¶åƒæ•¸æ˜¯éŸ¿æ‡‰å¼æ™‚(ref, reactive, computed)ï¼Œè‹¥åƒæ•¸çš„å€¼æ”¹è®Šï¼ŒuseFetchæœƒè‡ªå‹•é‡æ–°ç™¼é€è«‹æ±‚

- **ç¯„ä¾‹1**ï¼šç•¶idæ”¹è®Šæ™‚ï¼Œè³‡æ–™ä¹ŸæœƒåŒæ­¥æ›´æ–°
```vue
<script setup>
const id = ref(1)
const { data } = await useFetch(`https://jsonplaceholder.typicode.com/todos`, {
  params: { id }
})
</script>

<template>
    <div>
        {{ data }}
        <button type="button" class="btn-sm" @click="id--">id - 1</button>
        <button type="button" class="btn-sm" @click="id++">id + 1</button>
    </div>
</template>
```

- **ç¯„ä¾‹2**ï¼šç•¶nowPageæ”¹è®Šæ™‚ï¼ŒuseFetchæœƒè¢«è§¸ç™¼ï¼Œå–å¾—æ›´æ–°çš„è³‡æ–™

```vue
<script setup >
const nowPage = ref(1)
const lastPage = () => {
  nowPage.value --
}
const nextPage = () => {
  nowPage.value ++
}

const { data } = await useFetch(`${apiBase}/readallarticles`, {
  method: 'POST',
  body: {
    // å¦‚æœå‚³å…¥çš„æ˜¯nowPage.valueï¼Œä¸æœƒè§¸ç™¼è‡ªå‹•æ›´æ–°
    Page: nowPage,
    UserId: userData.value.id || '0'
  }
})
</script>

<template>

{{ data }}
<button type="button" @click="lastPage">ä¸Šä¸€é </button>
<button type="button" @click="nextPage">ä¸‹ä¸€é </button>

</template>

```

- å¯«æ³•2ï¼šåŠ å…¥watchåƒæ•¸ç›£è½
- **ç¯„ä¾‹**
```vue
<script setup>
const page = ref(1)
const { data: posts } = await useAsyncData(
  'posts',
  () => $fetch('https://fakeApi.com/posts', {
    params: {
      page: page.value
    }
  }), {
    watch: [page]
  }
)
</script>

```

## æ””æˆªå™¨ interceptors

```js
const { data, pending, error, refresh } = await useFetch('/api/auth/login', {
  onRequest({ request, options }) {
    // è¨­ç½® request headers
    options.headers = options.headers || {}
    options.headers.authorization = 'Bearer token'
  },
  onRequestError({ request, options, error }) {
    // è™•ç† request éŒ¯èª¤
  },
  onResponse({ request, response, options }) {
    // è™•ç†å›å‚³è³‡æ–™
    // è¦è¨˜å¾—return æ‰èƒ½ç”¨dataå–å¾—è³‡æ–™
    return response._data
  },
  onResponseError({ request, response, options }) {
    // è™•ç†å›å‚³éŒ¯èª¤
  }
})
```


## å¤šå€‹APIè«‹æ±‚

- å¦‚æœä¸€å€‹ä¸€å€‹åŸ·è¡Œï¼Œæœƒé€ æˆé˜»å¡

```jsx
const {data: userData} = await useFetch(url1)
const {data: areaData} = await useFetch(url2)
```

- å¯ä»¥ä½¿ç”¨Promise.allä¸€èµ·åŸ·è¡Œï¼Œéƒ½æœ‰è³‡æ–™å¾Œå†å›å‚³

```jsx
const [{data: userData}, {data: areaData}] = await Promise.all([
	useFetch(url1),
	useFetch(url2)
])
```

## é¿å…é‡è¤‡ç™¼APIè«‹æ±‚

- å¯ä»¥åœ¨piniaå…§å»ºç«‹ä¸€å€‹`isFetch`ç‹€æ…‹é™åˆ¶
- åªè¦`isFetch` ç‚ºtrueï¼Œä»£è¡¨å·²ç™¼é€è«‹æ±‚æ­£åœ¨ç­‰å¾…å›æ‡‰ï¼Œæ­¤æ™‚ç„¡æ³•å†æ¬¡è«‹æ±‚

```jsx
// stores / vote.js
export const useVoteStore = defineStore("vote", () => {
	const voteData = ref({})
	const isFetch = ref(false)
	
	const setVoteData = (data) => {
			voteData.value = data
	}
	
	const addVote = async (type) => {
		if(isFetch.value) return
		isFetch.value = true
	try {
			const data = await $fetch(url, {
			method: "POST",
			body: { type }
		})
		voteData.value = data
	} catch(error) {
		alert('éŒ¯èª¤')
	} finally {
		isFetch.value = false
		}
	}
	return { voteData, isFetch, setVoteData, addVote}
})

```

## å¿ƒå¾—
ç›®å‰åœ¨ä½¿ç”¨Nuxt3çš„fetchæ–¹æ³•æ„Ÿè¦ºé‚„ä¸æ˜¯å¾ˆç†Ÿç·´ï¼Œè¦å…ˆç¢ºèªéœ€æ±‚è¦åœ¨Serveré‚„æ˜¯Clientç«¯è«‹æ±‚ï¼Œæœ‰æ™‚å€™é‚„æœƒé‡åˆ°`Hydration mismatch`çš„å•é¡Œï¼Œä¹Ÿä¸åƒ`axios`å¯ä»¥å°è£ç®¡ç†ï¼Œåœ¨å°ˆé¡Œæ™‚å¯«äº†ä¸å°‘é‡è¤‡çš„codeï¼Œé‚„éœ€è¦å¤šç·´ç¿’å’Œå¤šçœ‹ä¸€äº›ç¯„ä¾‹å­¸ç¿’ã€‚

## åƒè€ƒè³‡æ–™
- [å®˜ç¶²](https://nuxt.com/docs/getting-started/data-fetching)
- [[Day 09] Nuxt 3 ç™¼é€ API è«‹æ±‚è³‡æ–™ - å¾ $fetch èˆ‡ useAsyncData åˆ° useFetch](https://ithelp.ithome.com.tw/articles/10326675)
- [[Day 11] Nuxt3 çš„ AJAX å®¶æ—ï¼šuseAsyncDataã€useFetchã€useLazyFetchã€useLazyAsyncData](https://ithelp.ithome.com.tw/m/articles/10298741)
- [Nuxt.js 3.x Data fetching ä¸²æ¥ APIï¼$fetchã€useAsyncDataã€useFetch](https://clairechang.tw/2023/07/19/nuxt3/nuxt-v3-data-fetching/)
- [React Patternï¼šç•¶é‡åˆ° Hydration Mismatch çš„è™•ç†æ–¹æ¡ˆ](https://hello-kirby.hashnode.dev/react-pattern-hydration-mismatch)
