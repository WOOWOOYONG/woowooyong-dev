---
title: 'Jestä½¿ç”¨ç­†è¨˜'
description: 'åŸºæœ¬çš„Jestèªæ³•ç·´ç¿’ç´€éŒ„'
date: '2023-10-21'
category: 'JavaScript'
tags:
  - JavaScript
  - Unit Test
---


# Jestä½¿ç”¨ç­†è¨˜

## ç°¡ä»‹

- æ˜¯ä¸€å€‹ç”±Facebooké–‹ç™¼çš„JavaScriptå–®å…ƒæ¸¬è©¦æ¡†æ¶
- å–®å…ƒæ¸¬è©¦(Unit Test)ï¼šé‡å°ç¨‹å¼ä¸­çš„æœ€å°å–®å…ƒé€²è¡Œæ¸¬è©¦
- ä¸»è¦å°æ–¼functioné€²è¡Œæ¸¬è©¦ï¼Œæ˜¯å¦ç¬¦åˆé æœŸé‹è¡Œçµæœ

## ç’°å¢ƒå»ºç½®

**ä½¿ç”¨npmå®‰è£**

```json
npm install --save-dev jest
```

- åœ¨**package.json**æª”æ¡ˆä¸­å¢åŠ æŒ‡ä»¤
- å¯ä»¥åœ¨çµ‚ç«¯æ©Ÿè¼¸å…¥ **npm run test** ä¾†åŸ·è¡Œjestæ¸¬è©¦

```json
{
  "scripts": {
    "test": "jest"
  }
}

// æŸ¥çœ‹æ¸¬è©¦è¦†è“‹ç‡
{
  "scripts": {
    "test": "jest --coverage"
  }
}

```
**è¨­å®šé…ç½®æ–‡ä»¶**
- è¼¸å…¥æŒ‡ä»¤ç”Ÿæˆ `jest.config` æª”æ¡ˆ
- åœ¨jest 29.7ç‰ˆä¸­ï¼Œå·²ç¶“å¯ä»¥ç›´æ¥ä½¿ç”¨ES6èªæ³•ï¼Œä¸éœ€å¦å¤–å®‰è£Babel
```json
npm init jest@latest
```
- æœƒå•ä¸€äº›é…ç½®å•é¡Œï¼Œæ ¹æ“šéœ€æ±‚é¸æ“‡

**ps: æ¸¬è©¦ç’°å¢ƒå·®åˆ¥**

1. Node (testEnvironment: 'node')

- é©åˆ Node.js æ‡‰ç”¨ç¨‹åºå’Œä¼ºæœå™¨ç«¯ä»£ç¢¼æä¾›çš„ç’°å¢ƒ
- **æ²’æœ‰** DOM ç›¸é—œçš„å…¨å±€è®Šæ•¸ï¼ˆä¾‹å¦‚ window æˆ– documentï¼‰
- æœ€é©åˆæ¸¬è©¦ç´” Node.js ä»£ç¢¼ï¼Œä¾‹å¦‚æœå‹™å™¨ç«¯é‚è¼¯


2. JSDOM (testEnvironment: 'jsdom')
- æ˜¯ä¸€å€‹ç”¨ JavaScript å¯¦ç¾çš„ DOM æ¨¡æ“¬å™¨
- æä¾› DOM ç›¸é—œçš„å…¨å±€è®Šæ•¸ï¼Œåƒæ˜¯ window æˆ– document
- å¯ä»¥åœ¨ Node.js ç’°å¢ƒä¸­æ¨¡æ“¬ç€è¦½å™¨çš„è¡Œç‚ºï¼Œä¸¦æ¸¬è©¦é‚£äº›èˆ‡ DOM äº’å‹•çš„ä»£ç¢¼
- æœ€é©åˆæ¸¬è©¦å‰ç«¯ä»£ç¢¼ï¼Œä¾‹å¦‚ React æˆ– Vue çµ„ä»¶

## åŸºæœ¬ç”¨æ³•

### 1. å»ºç«‹ä¸€å€‹jsæª”æ¡ˆ

- æ’°å¯«éœ€è¦ä½¿ç”¨çš„function
- ä½¿ç”¨`module.exports` æŠŠfunctionè¼¸å‡º

```jsx
// sum.js
function sum(a, b) {
  return a + b;
}
module.exports = sum;
```

### 2. å»ºç«‹ä¸€å€‹test.jsæª”æ¡ˆ

- ä½¿ç”¨`require`å¼•å…¥è¦æ¸¬è©¦çš„function

```jsx
//sum.test.js
const sum = require('./sum');

test('æ¸¬è©¦ 8+9 æœƒç­‰æ–¼17', () => {
  expect(sum(8, 9)).toBe(17); // passed
});
```

### 3. åŸºæœ¬èªæ³•

- **test / it**ï¼šå®šç¾©ä¸€å€‹å–®å…ƒæ¸¬è©¦

```jsx
test('è©²æ¸¬è©¦çš„èªªæ˜', () => {
	expect(è¦æ¸¬è©¦çš„function).toBe(é æœŸçš„çµæœ)
})

it('è©²æ¸¬è©¦çš„èªªæ˜', () => {
	expect(è¦æ¸¬è©¦çš„function).toBe(é æœŸçš„çµæœ)
})

```

- **describe**ï¼šå®šç¾©ç¾¤çµ„å–®å…ƒæ¸¬è©¦ï¼Œè£¡é¢å¯ä»¥æ”¾å¤šå€‹test

```jsx
describe('æ¸¬è©¦åŠ æ³•å‡½å¼', () => {

  test('æ¸¬è©¦ 8+9 æœƒç­‰æ–¼17', () => {
    expect(sum(8, 9)).toBe(17);
  });

  test('æ¸¬è©¦ 1+1 æœƒç­‰æ–¼2', () => {
    expect(sum(1, 1)).toBe(2);
  });

});
```

### ğŸ Modifiers


- **not**ï¼šç”¨æ–¼è¡¨ç¤ºå¦å®š

```jsx
expect(1 + 2).not.toBe(4)
```

- **resolves**ï¼šæª¢æŸ¥ä¸€å€‹ promise æ˜¯å¦æˆåŠŸ

```jsx
const promise = Promise.resolve('success');
expect(promise).resolves.toBe('success');
```

- **rejects**ï¼šæª¢æŸ¥ä¸€å€‹ promise æ˜¯å¦å¤±æ•—

```jsx
const promise = Promise.reject(new Error('failure'));
expect(promise).rejects.toThrow('failure');
```


### ğŸ å¸¸ç”¨çš„Matchers


- **toBeï¼š**ä½¿ç”¨Object.isä¾†æ¯”è¼ƒæ˜¯å¦ç›¸ç­‰ï¼Œå¸¸ç”¨æ–¼åŸå§‹å‹åˆ¥
- **toEqualï¼š**é€²è¡Œæ·±å±¤æ¬¡çš„å€¼æ¯”è¼ƒï¼Œé©ç”¨æ–¼Objectå’ŒArrayçš„æ¯”è¼ƒ

```jsx

test('object assign',() => {
	const a = {}
	expect(a).toBe({}) // failed
	expect(a).toEqual({}) // passed
})
```

- **toBeTruthy**ï¼šæª¢æŸ¥å€¼æ˜¯å¦ç‚º truthy
- **toBeFalsy**ï¼šæª¢æŸ¥å€¼æ˜¯å¦ç‚º falsy

```jsx
describe('truthy or falsey' ,() => {
	test('truthy', () => {
	  expect('Hello').toBeTruthy();
	});

	test('falsey', () => {
		expect(0).toBeFalsy();
	});

})
```

- **toContain**ï¼šæª¢æŸ¥é™£åˆ—æ˜¯å¦åŒ…å«æŸå€‹ç‰¹å®šå…ƒç´ 

```jsx
expect(['apple', 'banana', 'cherry']).toContain('banana');
```

- **toThrow**: æª¢æŸ¥å‡½æ•¸æ˜¯å¦æ‹‹å‡ºéŒ¯èª¤

```jsx
const throwFunction = () => {
    throw new Error('error!');
};
expect(throwFunction).toThrow('error!');
```


> **Numberçš„æ¯”è¼ƒ**
- **toBeGreaterThan**
- **toBeGreaterThanOrEqual**
- **toBeLessThan**
- **toBeLessThanOrEqual**

```jsx
describe('numbers', () => {
  const value = 8 + 9;
  test('8åŠ 9', () => {
    expect(value).toBe(17);
    expect(value).toBeGreaterThan(16);
    expect(value).toBeLessThan(21);
    expect(value).toBeLessThanOrEqual(18);
  });
});
```


### ğŸ éåŒæ­¥å‡½å¼æ¸¬è©¦

- åœ¨nodeç’°å¢ƒå®‰è£axios
- å–å¾—ä¸€å€‹todoæ¸¬è©¦

```jsx
// async.js
const axios = require('axios');

const fetchData = async (id) => {
  const res = await axios.get(`https://jsonplaceholder.typicode.com/todos/${id}`);
  return res.data;
};

module.exports = fetchData;
```

- å› ç‚ºæ˜¯éåŒæ­¥è¡Œç‚ºï¼Œè¦åŠ ä¸Šasyncâ€¦await

```jsx
const fetchData = require('./async');

test('it should return a todo', async () => {
  const todo = await fetchData(1);
  expect(todo.id).toBe(1);
});
```

### ğŸ å¸¸åœ¨ç¾¤çµ„æ¸¬è©¦ä½¿ç”¨çš„æ–¹æ³•

1. **beforeEach**:  åœ¨æ¯ä¸€å€‹å–®å…ƒæ¸¬è©¦ä¹‹å‰åŸ·è¡Œ
2. **afterEach**:  åœ¨æ¯ä¸€å€‹å–®å…ƒæ¸¬è©¦ä¹‹å¾ŒåŸ·è¡Œ
3. **beforeAll**:  åœ¨æ‰€æœ‰å–®å…ƒæ¸¬è©¦ä¹‹å‰åŸ·è¡Œä¸€æ¬¡
4. **afterAll**:  åœ¨æ‰€æœ‰å–®å…ƒæ¸¬è©¦ä¹‹å¾ŒåŸ·è¡Œä¸€æ¬¡

- å¯«åœ¨describeå…§ï¼Œè¡¨ç¤ºè©²çµ„æ¸¬è©¦æ‰æœƒç”¨åˆ°

```jsx
// ä½¿ç”¨ beforeEach å’Œ afterEach
let counter = 0;

describe("Counter Tests", () => {
		beforeAll(() => {
			console.log('æ¸¬è©¦é–‹å§‹äº†')
	  });
	
		afterAll(() => {
			console.log('æ¸¬è©¦çµæŸå›‰')
		})

    beforeEach(() => {
        counter = 0;
    });

    afterEach(() => {
        console.log(`Counter after test: ${counter}`);
    });

    test("Increment counter", () => {
        counter++;
        expect(counter).toBe(1);
    });

    test("Decrement counter", () => {
        counter--;
        expect(counter).toBe(-1);
    });
});
```

### 4. Mockç”¨æ³•

- **å¯ä»¥ä¸å—å¤–éƒ¨ä¾è³´ï¼ˆè³‡æ–™åº« , APIâ€¦ï¼‰ï¼Œå–®ç´”æ¨¡æ“¬æ¸¬è©¦åŠŸèƒ½**
1. **jest.fn**ï¼šå‰µå»ºæ¨¡æ“¬å‡½å¼

```jsx
const mockFn = jest.fn(scalar => 42 + scalar);

mockFn(0); // 42
mockFn(1); // 43
```

1. **mockReturnValue**ï¼šè¨­å®šå›å‚³çš„å€¼

```jsx
const mockFn = jest.fn();
mockFn.mockReturnValue(123);

expect(mockFunction()).toBe(123);
```

1. **mockReturnValueOnce**ï¼šåªå›å‚³ä¸€æ¬¡ï¼Œç”¨æ–¼åœ¨é€£çºŒèª¿ç”¨ä¸­å›å‚³ä¸åŒçš„å€¼

```jsx
const mockFn = jest.fn();
mockFn
  .mockReturnValueOnce('first call')
  .mockReturnValueOnce('second call');

// é¦–æ¬¡èª¿ç”¨
expect(mockFunction()).toBe('first call');

// ç¬¬äºŒæ¬¡èª¿ç”¨
expect(mockFunction()).toBe('second call');
```

1. **jest.spyOn**ï¼šç”¨æ–¼åµæ¸¬æŸç‰©ä»¶çš„æŸæ–¹æ³•æ˜¯å¦è¢«èª¿ç”¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒä¾†æ¨¡æ“¬æ–¹æ³•çš„è¿”å›å€¼æˆ–è¡Œç‚º
- ä½¿ç”¨ `jest.spyOn(axios, 'get')` ä¾†å‰µå»ºä¸€å€‹è§€å¯Ÿ `axios` çš„ `get` æ–¹æ³•çš„"é–“è«œ"
- é€™å€‹"é–“è«œ"æœƒæ””æˆªæ‰€æœ‰å° `axios.get` çš„èª¿ç”¨ï¼Œä¸¦å°å®ƒé€²è¡Œè¨˜éŒ„
- ä½¿ç”¨ `.mockReturnValueOnce()` æ–¹æ³•ä¾†æ¨¡æ“¬ `axios.get` åœ¨ä¸‹ä¸€æ¬¡èª¿ç”¨æ™‚çš„è¿”å›å€¼

```jsx
// asynctest.test.js

const fetchData = require('./async');
const axios = require('axios')

// æ¨¡æ“¬axios.get
test('mock axios', async () => {
  const spy = jest.spyOn(axios, 'get').mockReturnValueOnce({
    data: {
      id: 1,
      todo: 'Do Homework!',
    },
  });
  const res = await fetchData(1);
  expect(res.todo).toBe('Do Homework!');

	spy.mockRestore();
});
```

## åƒè€ƒè³‡æ–™

- [JESTå®˜ç¶²](https://jestjs.io/docs/getting-started)
- [Jest | æ¸¬è©¦è¨­ç½®åˆ†é¡ï¼ˆdescribeï¼‰åŠä½œç”¨åŸŸï¼ˆscopingï¼‰](https://medium.com/enjoy-life-enjoy-coding/unit-test-%E6%9B%BF%E6%B8%AC%E8%A9%A6%E8%A8%AD%E7%BD%AE%E5%88%86%E9%A1%9E-describe-%E5%8F%8A%E4%BD%9C%E7%94%A8%E5%9F%9F-scoping-2c5082266ca)
- [ååˆ†é˜ä¸Šæ‰‹å‰ç«¯å–®å…ƒæ¸¬è©¦ - ä½¿ç”¨ Jest](https://www.casper.tw/development/2020/02/02/jest-intro/)
- [Jest Crash Course - Learn How to Test your JavaScript Application](https://www.youtube.com/watch?v=ajiAl5UNzBU)