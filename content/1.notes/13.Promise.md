---
title: 'Promise - æœƒçµ¦ä½ å›è¦†çš„ï¼Œæˆ‘ä¿è­‰ï¼'
description: 'éåŒæ­¥è™•ç†çš„é—œéµï¼ŒPromiseå¦‚ä½•é‹ä½œ'
date: '2023-10-25'
category: 'JavaScript'
tags:
  - JavaScript
  - ES6
---

# Promise

## ç°¡ä»‹

- ä¸»è¦ç”¨æ–¼éåŒæ­¥æ“ä½œï¼Œæ˜¯ä¸€å€‹ç”± asynchronous function return çš„ç‰©ä»¶
- ç”¨ä¾†è¡¨ç¤º**ä¸€å€‹ç•°æ­¥æ“ä½œçš„æœ€ç»ˆå®Œæˆï¼ˆæˆ–å¤±æ•—ï¼‰åŠå…¶ç»“æœå€¼**
- ä»£ç†ä¸€å€‹å»ºç«‹æ™‚ä¸ç”¨é å…ˆå¾—çŸ¥çµæœçš„å€¼
- è§£æ±º`callback hell`çš„å•é¡Œ......æˆ‘çš„è¶…äºº

## èªæ³•

- åªèƒ½ä½¿ç”¨`new`é—œéµå­—å‰µå»º

```js
new Promise(executor)
```

## Promise æ§‹é€ å‡½å¼åŒ…å«å…©å€‹åƒæ•¸:

1. `resolve`

- å°‡ promise çš„ç‹€æ…‹å¾ pending æ›´æ”¹ç‚º fulfilledï¼ˆæˆåŠŸï¼‰
- å°‡éåŒæ­¥å‡½å¼åŸ·è¡Œå¾Œçš„çµæœä½œç‚ºåƒæ•¸å‚³é€çµ¦`.then( )`

2. `reject`

- å°‡ promise çš„ç‹€æ…‹å¾ pending æ›´æ”¹ç‚º rejected ï¼ˆå¤±æ•—ï¼‰
- å°‡éŒ¯èª¤è¨Šæ¯ä½œç‚ºåƒæ•¸å‚³é€çµ¦`.catch( )`

## Promise ç‹€æ…‹

- `pending`ï¼šäº‹ä»¶é‹è¡Œä¸­ï¼Œå°šæœªå–å¾—çµæœ(åˆå§‹ç‹€æ…‹)
- `resolved`ï¼šäº‹ä»¶å·²ç¶“åŸ·è¡Œå®Œç•¢ä¸”æˆåŠŸæ“ä½œï¼Œå›å‚³ resolve çš„çµæœï¼ˆè©²æ‰¿è«¾å·²ç¶“è¢«å¯¦ç¾ fulfilledï¼‰
- `rejected`ï¼šäº‹ä»¶å·²ç¶“åŸ·è¡Œå®Œç•¢ä½†æ“ä½œå¤±æ•—ï¼Œå›å‚³ rejected çš„çµæœ

```js
promise()
  .then((success) => {
    console.log(success)
  })
  .catch((fail) => {
    console.log(fail)
  })
```

**ç¯„ä¾‹ï¼šå‰µå»ºä¸€å€‹ promise**

```js
const getUser = new Promise((resolve, reject) => {
  // Do some async task
  setTimeout(() => {
    let error = false
    if (!error) {
      resolve({ name: 'Blur', age: 40 })
    } else {
      reject('Error: Something went wrong...')
    }
  }, 1000)
})

getUser
  .then((user) => console.log(user))
  .catch((error) => console.log(error))
  .finally(() => console.log('The promise has been resolved or rejected'))
```

ğŸ¤” **å‰µå»º Promise æ§‹é€ å‡½å¼ï¼Œ`executor`å…§çš„ç¨‹å¼ç¢¼æ˜¯æœƒç«‹å³åŸ·è¡Œçš„**

**ç¯„ä¾‹ 1**

```js
console.log('é–‹å§‹')

const myPromise = new Promise((resolve, reject) => {
  console.log('Promiseå…§éƒ¨ (åŒæ­¥åŸ·è¡Œ)')
  resolve()
})

console.log('çµæŸ')

// output
// é–‹å§‹
// Promiseå…§éƒ¨ (åŒæ­¥åŸ·è¡Œ)
// çµæŸ
```

**ç¯„ä¾‹ 2**

```js
// This is a JavaScript Quiz from BFE.dev

console.log(1)
const promise = new Promise((resolve) => {
  console.log(2)
  resolve()
  console.log(3)
})

console.log(4)

promise
  .then(() => {
    console.log(5)
  })
  .then(() => {
    console.log(6)
  })

console.log(7)

setTimeout(() => {
  console.log(8)
}, 10)

setTimeout(() => {
  console.log(9)
}, 0)

// å‡ºç¾é †åºï¼š1 2 3 4 7 5 6 9 8
```

ğŸ¤” **å¦‚æœæœ‰å…©å€‹`resolve`æ™‚**

- ä¸€é–‹å§‹èª¿ç”¨äº†`resolve(1)`ï¼ŒPromise çš„ç‹€æ…‹å¾`Pending`è¢«ä¿®æ”¹æˆ`fulfilled`
- å¾ŒçºŒçš„`resolve`å’Œ`reject`éƒ½æœƒè¢«å¿½ç•¥

```js
new Promise((resolve, reject) => {
  resolve(1)
  resolve(2)
  reject('error')
}).then(
  (value) => {
    console.log(value)
  },
  (error) => {
    console.log('error')
  }
)

// output
// 1
```

**ç¯„ä¾‹ï¼šæ±ºå®šéåŒæ­¥å‡½å¼çš„åŸ·è¡Œé †åº**

- å¸Œæœ›åŸ·è¡Œé †åºï¼š fun1 => fun2 => fun3

```js
// ä½¿ç”¨Promise
function fun1() {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve('hello')
    }, 3000)
  })
}

function fun2(data) {
  return new Promise((resolve, rejcet) => {
    setTimeout(() => {
      resolve(data)
    }, 2000)
  })
}

function fun3(data) {
  return new Promise((resolve, reject) => {
    console.log(data)
  })
}

fun1()
  .then(fun2)
  .then(fun3)
  .catch((error) => {
    console.log(error)
  })
// åŸ·è¡Œfun1ï¼Œ3ç§’å¾Œå°‡resolveçš„çµæœ'hello'ä½œç‚ºåƒæ•¸å›å‚³çµ¦fun2
// fun2æ¥æ”¶åˆ°'hello'ï¼Œ2ç§’å¾Œå°‡resolveçš„çµæœ'hello'ä½œç‚ºåƒæ•¸å›å‚³çµ¦fun3
// fun3 å°å‡º 'hello'
```

```js
// ä¸ä½¿ç”¨Promsie
function fun1(callback) {
  setTimeout(() => {
    callback('hello')
  }, 3000)
}

function fun2(data, callback) {
  setTimeout(() => {
    callback(data)
  }, 2000)
}

function fun3(data) {
  console.log(data)
}

//
fun1((resultFromFun1) => {
  fun2(resultFromFun1, (resultFromFun2) => {
    fun3(resultFromFun2)
  })
})
```

**ç¯„ä¾‹ï¼šå‚³å…¥çš„æ•¸å­—æ˜¯å¦å¤§æ–¼ 5**

```js
//example
const getSomeData = (num) => {
  return new Promise((resolve, reject) => {
    if (num > 5) {
      resolve('resolve number > 5')
    }
    reject('reject number < 5')
  })
}

getSomeData(10)
  .then((data) => {
    return getSomeData(0)
  })
  .catch((err) => {
    return getSomeData(10)
  })
  .then((data) => {
    console.log(data)
  })
  .finally(() => {
    console.log('finally')
  })
```

## Promise æ–¹æ³•

1. `Promise.all`

- **ç›®çš„**ï¼šè®“å¤šå€‹ promise åŒæ™‚åŸ·è¡Œ
- åƒæ•¸æ¥å—ä¸€å€‹å¯è¿­ä»£çš„ç‰©ä»¶ï¼Œä½†é€šå¸¸æœƒå‚³å…¥ promise çµ„æˆçš„ array ä½œç‚ºåƒæ•¸
- æ¯å€‹ promise å®Œæˆæ™‚ï¼Œresolve çš„å€¼æœƒå­˜å…¥é™£åˆ—ä¸­
- å¦‚æœå…¶ä¸­ä»»ä½•ä¸€å€‹ Promise å¤±æ•—ï¼Œæœƒå›å‚³ç¬¬ä¸€å€‹å¤±æ•—çš„ Promise ç‰©ä»¶

**ç¯„ä¾‹**

```js
//1
const fetchPromise1 = fetch('url1');
const fetchPromise2 = fetch('url2');
const fetchPromise3 = fetch('url3');

Promise.all([fetchPromise1,fetchPromise2,fetchPromise3])
    //return ä¸€å€‹é™£åˆ—
    .then((responses) => {
    responses.forEach((res)=> {
        console.log(res)
    })
 })
)
//[result1, result2, result3]

//2
const promise1 = Promise.resolve(1);
const promise2 = Promise.reject("Error");
const promise3 = Promise.resolve(3);

Promise.all([promise1, promise2, promise3]).catch((error) => {
  console.log(error); // "Error"
});
```

2. `Promise.any`

- åªè¦ Promise array ä¸­çš„ä»»ä½•ä¸€å€‹è«‹æ±‚æˆåŠŸå°±åŸ·è¡Œ.then()ï¼Œä¸¦å›å‚³é€™å€‹ resolve çš„çµæœ
- å¦‚æœæ‰€æœ‰ promises éƒ½è¢«æ‹’çµ•ï¼Œå‰‡åŸ·è¡Œ.catch()ï¼Œå›å‚³ AggregateErrorï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰ Promise çš„æ‹’çµ•åŸå› 

**ç¯„ä¾‹**

```js
const promises = [Promise.resolve('hello'), Promise.reject('failed'), Promise.resolve('world')]

Promise.any(promises)
  .then((result) => console.log(result))
  .catch((error) => console.error(error))

// hello
```

3. `Promise.race`

- ä»»ä½•ä¸€å€‹"é™£åˆ—å‚³å…¥åƒæ•¸çš„ Promise ç‰©ä»¶æœ‰è§£æ±ºï¼Œå°±æœƒåˆ°ä¸‹ä¸€æ­¥å»

**ç¯„ä¾‹**

```js
const getSomeData = (num, time) => {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      if (num > 0) {
        resolve(`${num} > 0`)
      } else {
        reject(`${num} < 0`)
      }
    }, time)
  })
}

Promise.race([getSomeData(10, 500), getSomeData(5, 1000)])
  .then((data) => {
    console.log(data)
  })
  .catch((err) => {
    console.log(err)
  })

// '10 > 0'
```

## async....await

- Promise çš„èªæ³•ç³–ï¼Œæé«˜ç¨‹å¼ç¢¼å¯è®€æ€§ï¼Œå°‘å¯«å¾ˆå¤š`.then()`
- æ‰€æœ‰çš„ async function éƒ½æœƒ return ä¸€å€‹ Promise Object
- async å®£å‘Šä¸€å€‹éåŒæ­¥å‡½å¼ï¼Œawait ç­‰å¾… Promise çš„ resolveï¼reject
- await æœƒå›å‚³ Promise resolveï¼reject çš„çµæœ
- ä½¿ç”¨ try / catch ä¾†å€åˆ† resolveï¼reject è¦åŸ·è¡Œçš„å€åŸŸ

```js
aysnc function myFunc() {
    return 99;
}
let result = myFunc();
console.log(result) //å¾—åˆ°ä¸€å€‹Promiseç‰©ä»¶

//å–å¾—returnçš„å€¼
result.then((data) => console.log(data)); //99
```

**ç¯„ä¾‹ï¼šç™¼å‡º get è«‹æ±‚**

```js
async function fetchProduct(){
    try{
        const response = await fetch(url');
        const data = await response.json();
        console.log(data);
    } catch(err){
        console.log(err)
    }
  }

fetchProduct();
```

**ç¯„ä¾‹ï¼šç™¼å‡º post è«‹æ±‚**

```js
async function postData(url = '', data = {}) {
  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
    return response.json()
  } catch (error) {
    console.error(error)
    throw error // å†æ¬¡æŠ›å‡ºç•°å¸¸ï¼Œä»¥ä¾¿ä¸Šå±¤ä»£ç¢¼é€²è¡Œé€²ä¸€æ­¥è™•ç†
  }
}

// ä½¿ç”¨ç¯„ä¾‹ï¼š
postData('<https://example.com/api/posts>', { title: 'foo', body: 'bar', userId: 1 })
  .then((data) => {
    console.log(data)
  })
  .catch((error) => {
    console.error(error)
  })
```

**ç¯„ä¾‹ï¼š**`.then()` **&** `await` **å¯«æ³•æ¯”è¼ƒ**

```js
//ä½¿ç”¨await
async function getApiData() {
  const data = await fetch(url)
  const result = await data.json()
  console.log(result)
}

//ä½¿ç”¨.then
async function getApiData2() {
  fetch(url)
    .then((data) => data.json())
    .then((result) => {
      console.log(result)
    })
}
```

**ç¯„ä¾‹ï¼šä½¿ç”¨ç®­é ­å‡½å¼**

```js
const getApiData = async () => {
  const response = await fetch(url)
    .then((res) => {
      return res.json()
    })
    .then((data) => console.log(data))
    .catch((err) => console.log(err))
}
```

**ç¯„ä¾‹ï¼štry & catch ä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨åŒæ­¥å‡½å¼**

```js
function double(num) {
  if (isNaN(num)) {
    throw new Error(`${num} is not a number`)
  }
  return num * 2
}

try {
  const x = double(3)
  console.log(x) // 6
} catch (err) {
  console.log(err)
}
```

## åƒè€ƒè³‡æ–™

- [MDN](https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/Promise)
- [éåŒæ­¥èˆ‡ PROMISE](https://openhome.cc/zh-tw/javascript/es-function/promise/)
